from pjr import *
from matplotlib.backends.backend_pdf import PdfPages

fname ="/pic/scratch/d3x345/model_runs/acme_lowres_compare_fluxes/run/out.nc"
fname="/pic/scratch/d3x345/model_runs/acme_lowres_compare_fluxes/run/acme_lowres_compare_fluxes.cam.h0.0000-10-01-00000.nc"
f = cdms2.open(fname)

varlist = f.listvariables();
dims = f.listdimension();

V1 = f("QFLXC",squeeze=1)
V2 = f("WPRTP_SFC2",squeeze=1)

V1 = V1*86400.
V1.units = 'mm/day'
V2 = V2*86400.
V2.units = 'mm/day'

LF = f('LANDFRAC',squeeze=1)

AREA = f('area',squeeze=1)
AREA = AREA/AREA.sum()
print "AREA sum", AREA.sum()

LFG = cdutil.averager(LF,axis='xy',weights=AREA)
print "LFG", LFG

V1G = cdutil.averager(V1,axis='xy',weights=AREA)
print "V1G, and range", V1G, V1.min(), V1.max()

V2G = cdutil.averager(V2,axis='xy',weights=AREA)
print "V2G, and range", V2G, V2.min(), V2.max() 

lmax = 30.
lmin = -10.

# Create a Figure object.
fig = plt.figure(figsize=(4, 4))
fig.subplots_adjust(left=0.3)
# Create an Axes object.
ax = fig.add_subplot(1,1,1) # one row, one column, first plot

# Add a title.
ax.set_title("water fluxes (mm/day)")
# Add some axis labels.
ax.set_xlabel("QFLXC")
ax.set_ylabel("WPRTPX")
ax.plot([lmin,lmax],[lmin,lmax],'.r-')

ax.scatter(V1,V2)
ax.set_ylim([lmin,lmax])
ax.set_xlim([lmin,lmax])

fig.savefig('scatter.png', format='png')
plt.close() # close figure window
plt.clf() # clear figure
#plt.show()

D = V1 - V2
RD = 2*D/(abs(V1)+abs(V2))
print "Relative Error max and min ", RD.max(), RD.min()
print " Error Max and min ", D.max(), D.min()
maxlist  = zip(*np.where(D==D.max()))
minlist  = zip(*np.where(D==D.min()))
print "points where D is a maximum, minimum = ", len(maxlist), len(minlist)

lat = f['lat']
lon = f['lon']
#print "coords of maxerr ", lon[maxerrind], lat[maxerrind]
lat = f['lat']
cs = plt.contourf(lon, lat, D)
plt.contour(lon, lat, LF,levels=[0.5])
cbar = plt.colorbar(cs)
#plt.show()
plt.savefig('latlon.png', format='png')
